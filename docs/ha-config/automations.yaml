# HDMI Matrix Proxy - Automations
# Two-way sync between input selects and matrix routing

# Sync routing state to input selects (updates dropdowns when matrix changes)
- id: matrix_sync_routing_to_selects
  alias: "HDMI Matrix - Sync Routing to Input Selects"
  trigger:
    - platform: state
      entity_id: sensor.hdmi_matrix_routing
  action:
    - service: input_select.select_option
      target:
        entity_id: input_select.matrix_output_1_source
      data:
        option: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {{ (outputs | selectattr('output', 'eq', 1) | first).input | string }}
          {% else %}
            '1'
          {% endif %}
    - service: input_select.select_option
      target:
        entity_id: input_select.matrix_output_2_source
      data:
        option: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {{ (outputs | selectattr('output', 'eq', 2) | first).input | string }}
          {% else %}
            '1'
          {% endif %}
    - service: input_select.select_option
      target:
        entity_id: input_select.matrix_output_3_source
      data:
        option: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {{ (outputs | selectattr('output', 'eq', 3) | first).input | string }}
          {% else %}
            '1'
          {% endif %}
    - service: input_select.select_option
      target:
        entity_id: input_select.matrix_output_4_source
      data:
        option: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {{ (outputs | selectattr('output', 'eq', 4) | first).input | string }}
          {% else %}
            '1'
          {% endif %}
    - service: input_select.select_option
      target:
        entity_id: input_select.matrix_output_5_source
      data:
        option: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {{ (outputs | selectattr('output', 'eq', 5) | first).input | string }}
          {% else %}
            '1'
          {% endif %}
    - service: input_select.select_option
      target:
        entity_id: input_select.matrix_output_6_source
      data:
        option: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {{ (outputs | selectattr('output', 'eq', 6) | first).input | string }}
          {% else %}
            '1'
          {% endif %}
    - service: input_select.select_option
      target:
        entity_id: input_select.matrix_output_7_source
      data:
        option: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {{ (outputs | selectattr('output', 'eq', 7) | first).input | string }}
          {% else %}
            '1'
          {% endif %}
    - service: input_select.select_option
      target:
        entity_id: input_select.matrix_output_8_source
      data:
        option: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {{ (outputs | selectattr('output', 'eq', 8) | first).input | string }}
          {% else %}
            '1'
          {% endif %}

# Output 1 automation
- id: matrix_output_1_changed
  alias: "HDMI Matrix - Output 1 Changed"
  trigger:
    - platform: state
      entity_id: input_select.matrix_output_1_source
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' and trigger.to_state.state != 'unavailable' }}"
  action:
    - service: rest_command.matrix_route_output_1
      data:
        input: "{{ trigger.to_state.state | int }}"

# Output 2 automation
- id: matrix_output_2_changed
  alias: "HDMI Matrix - Output 2 Changed"
  trigger:
    - platform: state
      entity_id: input_select.matrix_output_2_source
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' and trigger.to_state.state != 'unavailable' }}"
  action:
    - service: rest_command.matrix_route_output_2
      data:
        input: "{{ trigger.to_state.state | int }}"

# Output 3 automation
- id: matrix_output_3_changed
  alias: "HDMI Matrix - Output 3 Changed"
  trigger:
    - platform: state
      entity_id: input_select.matrix_output_3_source
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' and trigger.to_state.state != 'unavailable' }}"
  action:
    - service: rest_command.matrix_route_output_3
      data:
        input: "{{ trigger.to_state.state | int }}"

# Output 4 automation
- id: matrix_output_4_changed
  alias: "HDMI Matrix - Output 4 Changed"
  trigger:
    - platform: state
      entity_id: input_select.matrix_output_4_source
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' and trigger.to_state.state != 'unavailable' }}"
  action:
    - service: rest_command.matrix_route_output_4
      data:
        input: "{{ trigger.to_state.state | int }}"

# Output 5 automation
- id: matrix_output_5_changed
  alias: "HDMI Matrix - Output 5 Changed"
  trigger:
    - platform: state
      entity_id: input_select.matrix_output_5_source
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' and trigger.to_state.state != 'unavailable' }}"
  action:
    - service: rest_command.matrix_route_output_5
      data:
        input: "{{ trigger.to_state.state | int }}"

# Output 6 automation
- id: matrix_output_6_changed
  alias: "HDMI Matrix - Output 6 Changed"
  trigger:
    - platform: state
      entity_id: input_select.matrix_output_6_source
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' and trigger.to_state.state != 'unavailable' }}"
  action:
    - service: rest_command.matrix_route_output_6
      data:
        input: "{{ trigger.to_state.state | int }}"

# Output 7 automation
- id: matrix_output_7_changed
  alias: "HDMI Matrix - Output 7 Changed"
  trigger:
    - platform: state
      entity_id: input_select.matrix_output_7_source
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' and trigger.to_state.state != 'unavailable' }}"
  action:
    - service: rest_command.matrix_route_output_7
      data:
        input: "{{ trigger.to_state.state | int }}"

# Output 8 automation
- id: matrix_output_8_changed
  alias: "HDMI Matrix - Output 8 Changed"
  trigger:
    - platform: state
      entity_id: input_select.matrix_output_8_source
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' and trigger.to_state.state != 'unavailable' }}"
  action:
    - service: rest_command.matrix_route_output_8
      data:
        input: "{{ trigger.to_state.state | int }}"
