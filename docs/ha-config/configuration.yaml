# HDMI Matrix Proxy - Home Assistant Configuration
# Copy these sections into your main configuration.yaml
#
# This configuration uses the API's name-based routing feature.
# Input names are pulled from the matrix and used directly in dropdowns.
# No need to configure names in two places!

# ============================================================================
# REST API Integration
# ============================================================================
rest:
  # Input names list - for populating dropdown options
  - resource: "http://hdmi-matrix-proxy:8080/api/inputs"
    scan_interval: 300  # Refresh every 5 minutes (names don't change often)
    sensor:
      - name: "HDMI Matrix Inputs"
        value_template: "{{ value_json.inputs | length }}"
        json_attributes:
          - inputs
          - names
        icon: mdi:video-input-hdmi

  # Output names list
  - resource: "http://hdmi-matrix-proxy:8080/api/outputs"
    scan_interval: 300
    sensor:
      - name: "HDMI Matrix Outputs"
        value_template: "{{ value_json.outputs | length }}"
        json_attributes:
          - outputs
          - names
        icon: mdi:television

  # Main routing sensor - current state
  - resource: "http://hdmi-matrix-proxy:8080/api/routing"
    scan_interval: 10
    sensor:
      - name: "HDMI Matrix Routing"
        value_template: "{{ value_json.outputs | length }}"
        json_attributes:
          - outputs
          - input_names
          - output_names
        icon: mdi:video-switch

  # Status sensor
  - resource: "http://hdmi-matrix-proxy:8080/api/status"
    scan_interval: 30
    sensor:
      - name: "HDMI Matrix Status"
        value_template: "{{ value_json.connection }}"
        json_attributes:
          - url
          - last_command
        icon: mdi:lan-connect

  # Health sensor
  - resource: "http://hdmi-matrix-proxy:8080/healthz/ready"
    scan_interval: 30
    sensor:
      - name: "HDMI Matrix Health"
        value_template: "{{ value_json.status }}"
        json_attributes:
          - matrix_connected
          - uptime_seconds
        icon: mdi:heart-pulse

# ============================================================================
# REST Commands for routing - Now accepts names for BOTH outputs AND inputs!
# ============================================================================
rest_command:
  # Generic routing command - accepts output AND input by NAME or number
  # Usage: service: rest_command.matrix_route
  #        data:
  #          output: "Living Room TV"   # or just: output: 1
  #          input: "PlayStation 5"     # or just: input: 3
  matrix_route:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/{{ output | urlencode }}"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  # Individual output commands (for backward compatibility)
  matrix_route_output_1:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/1"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  matrix_route_output_2:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/2"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  matrix_route_output_3:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/3"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  matrix_route_output_4:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/4"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  matrix_route_output_5:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/5"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  matrix_route_output_6:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/6"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  matrix_route_output_7:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/7"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  matrix_route_output_8:
    url: "http://hdmi-matrix-proxy:8080/api/routing/output/8"
    method: POST
    content_type: "application/json"
    payload: '{"input": "{{ input }}"}'

  # Preset routing command - accepts names for BOTH outputs AND inputs!
  # Examples:
  #   {"mappings": {"1": "Apple TV", "2": "PlayStation 5"}}
  #   {"mappings": {"Living Room TV": "Apple TV", "Bedroom TV": "PlayStation 5"}}
  matrix_preset:
    url: "http://hdmi-matrix-proxy:8080/api/routing/preset"
    method: POST
    content_type: "application/json"
    payload: '{{ mappings }}'

# ============================================================================
# Input Select Helpers
# Options are dynamically populated from the API on startup (see automations)
# These defaults are just placeholders - they get replaced automatically
# ============================================================================
input_select:
  matrix_output_1_source:
    name: "Output 1 Source"
    options: &input_options_placeholder
      - "Loading..."
    icon: mdi:television

  matrix_output_2_source:
    name: "Output 2 Source"
    options: *input_options_placeholder
    icon: mdi:television

  matrix_output_3_source:
    name: "Output 3 Source"
    options: *input_options_placeholder
    icon: mdi:television

  matrix_output_4_source:
    name: "Output 4 Source"
    options: *input_options_placeholder
    icon: mdi:television

  matrix_output_5_source:
    name: "Output 5 Source"
    options: *input_options_placeholder
    icon: mdi:television

  matrix_output_6_source:
    name: "Output 6 Source"
    options: *input_options_placeholder
    icon: mdi:television

  matrix_output_7_source:
    name: "Output 7 Source"
    options: *input_options_placeholder
    icon: mdi:television

  matrix_output_8_source:
    name: "Output 8 Source"
    options: *input_options_placeholder
    icon: mdi:television

# ============================================================================
# Note: Output names are pulled from the API dynamically
# The template sensors below will show the output names from your matrix
# No need to hardcode them here!
# ============================================================================

# ============================================================================
# Template Sensors - Show current source for each output
# ============================================================================
template:
  - sensor:
      - name: "Matrix Output 1 Current Source"
        unique_id: matrix_output_1_current_source
        state: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {% set output = outputs | selectattr('output', 'eq', 1) | first %}
            {{ output.input_name if output.input_name else 'Unknown' }}
          {% else %}
            Unknown
          {% endif %}
        attributes:
          output_name: >
            {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
            {% if outputs %}
              {% set output = outputs | selectattr('output', 'eq', 1) | first %}
              {{ output.output_name if output.output_name else 'Output 1' }}
            {% else %}
              Output 1
            {% endif %}
        icon: mdi:television

      - name: "Matrix Output 2 Current Source"
        unique_id: matrix_output_2_current_source
        state: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {% set output = outputs | selectattr('output', 'eq', 2) | first %}
            {{ output.input_name if output.input_name else 'Unknown' }}
          {% else %}
            Unknown
          {% endif %}
        attributes:
          output_name: >
            {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
            {% if outputs %}
              {% set output = outputs | selectattr('output', 'eq', 2) | first %}
              {{ output.output_name if output.output_name else 'Output 2' }}
            {% else %}
              Output 2
            {% endif %}
        icon: mdi:television

      - name: "Matrix Output 3 Current Source"
        unique_id: matrix_output_3_current_source
        state: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {% set output = outputs | selectattr('output', 'eq', 3) | first %}
            {{ output.input_name if output.input_name else 'Unknown' }}
          {% else %}
            Unknown
          {% endif %}
        attributes:
          output_name: >
            {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
            {% if outputs %}
              {% set output = outputs | selectattr('output', 'eq', 3) | first %}
              {{ output.output_name if output.output_name else 'Output 3' }}
            {% else %}
              Output 3
            {% endif %}
        icon: mdi:monitor

      - name: "Matrix Output 4 Current Source"
        unique_id: matrix_output_4_current_source
        state: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {% set output = outputs | selectattr('output', 'eq', 4) | first %}
            {{ output.input_name if output.input_name else 'Unknown' }}
          {% else %}
            Unknown
          {% endif %}
        attributes:
          output_name: >
            {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
            {% if outputs %}
              {% set output = outputs | selectattr('output', 'eq', 4) | first %}
              {{ output.output_name if output.output_name else 'Output 4' }}
            {% else %}
              Output 4
            {% endif %}
        icon: mdi:television

      - name: "Matrix Output 5 Current Source"
        unique_id: matrix_output_5_current_source
        state: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {% set output = outputs | selectattr('output', 'eq', 5) | first %}
            {{ output.input_name if output.input_name else 'Unknown' }}
          {% else %}
            Unknown
          {% endif %}
        attributes:
          output_name: >
            {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
            {% if outputs %}
              {% set output = outputs | selectattr('output', 'eq', 5) | first %}
              {{ output.output_name if output.output_name else 'Output 5' }}
            {% else %}
              Output 5
            {% endif %}
        icon: mdi:television

      - name: "Matrix Output 6 Current Source"
        unique_id: matrix_output_6_current_source
        state: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {% set output = outputs | selectattr('output', 'eq', 6) | first %}
            {{ output.input_name if output.input_name else 'Unknown' }}
          {% else %}
            Unknown
          {% endif %}
        attributes:
          output_name: >
            {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
            {% if outputs %}
              {% set output = outputs | selectattr('output', 'eq', 6) | first %}
              {{ output.output_name if output.output_name else 'Output 6' }}
            {% else %}
              Output 6
            {% endif %}
        icon: mdi:television

      - name: "Matrix Output 7 Current Source"
        unique_id: matrix_output_7_current_source
        state: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {% set output = outputs | selectattr('output', 'eq', 7) | first %}
            {{ output.input_name if output.input_name else 'Unknown' }}
          {% else %}
            Unknown
          {% endif %}
        attributes:
          output_name: >
            {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
            {% if outputs %}
              {% set output = outputs | selectattr('output', 'eq', 7) | first %}
              {{ output.output_name if output.output_name else 'Output 7' }}
            {% else %}
              Output 7
            {% endif %}
        icon: mdi:television

      - name: "Matrix Output 8 Current Source"
        unique_id: matrix_output_8_current_source
        state: >
          {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
          {% if outputs %}
            {% set output = outputs | selectattr('output', 'eq', 8) | first %}
            {{ output.input_name if output.input_name else 'Unknown' }}
          {% else %}
            Unknown
          {% endif %}
        attributes:
          output_name: >
            {% set outputs = state_attr('sensor.hdmi_matrix_routing', 'outputs') %}
            {% if outputs %}
              {% set output = outputs | selectattr('output', 'eq', 8) | first %}
              {{ output.output_name if output.output_name else 'Output 8' }}
            {% else %}
              Output 8
            {% endif %}
        icon: mdi:monitor
